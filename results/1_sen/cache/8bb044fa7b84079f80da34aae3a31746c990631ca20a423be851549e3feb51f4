{"identifier": "traccar-traccar-6f59f756a7d3", "patch": "    private Position decodePosition(\n            Channel channel, DeviceSession deviceSession, ByteBuf buf, int type, int index, ByteBuf imei) {\n        Position position = new Position(getProtocolName());\n        position.setDeviceId(deviceSession.getDeviceId());\n        position.set(Position.KEY_INDEX, index);\n        if (header != 0x2727) {\n            buf.readUnsignedShort(); \n            buf.readUnsignedShort(); \n            buf.readUnsignedByte(); \n            buf.readUnsignedShort(); \n            position.set(Position.KEY_RSSI, BitUtil.to(buf.readUnsignedShort(), 7));\n        }\n        int status = buf.readUnsignedByte();\n        position.set(Position.KEY_SATELLITES, BitUtil.to(status, 5));\n        if (header != 0x2727) {\n            buf.readUnsignedByte(); \n            buf.readUnsignedByte(); \n            buf.readUnsignedByte(); \n            buf.readUnsignedByte(); \n            buf.readUnsignedShort(); \n            int io = buf.readUnsignedShort();\n            position.set(Position.KEY_IGNITION, BitUtil.check(io, 14));\n            position.set(\"ac\", BitUtil.check(io, 13));\n            position.set(Position.PREFIX_IN + 3, BitUtil.check(io, 12));\n            position.set(Position.PREFIX_IN + 4, BitUtil.check(io, 11));\n            if (type == MSG_GPS_2 || type == MSG_ALARM_2) {\n                position.set(Position.KEY_OUTPUT, buf.readUnsignedByte());\n                buf.readUnsignedByte(); \n            } else {\n                position.set(Position.PREFIX_OUT + 1, BitUtil.check(io, 7));\n                position.set(Position.PREFIX_OUT + 2, BitUtil.check(io, 8));\n                position.set(Position.PREFIX_OUT + 3, BitUtil.check(io, 9));\n            }\n            if (header != 0x2626) {\n                int adcCount = type == MSG_GPS_2 || type == MSG_ALARM_2 ? 5 : 2;\n                for (int i = 1; i <= adcCount; i++) {\n                    String value = ByteBufUtil.hexDump(buf.readSlice(2));\n                    if (!value.equals(\"ffff\")) {\n                       position.set(\"adc\" + i, value);\n                    }\n                }\n            }\n        }\n        int alarm = buf.readUnsignedByte();\n        position.set(Position.KEY_ALARM, header != 0x2727 ? decodeAlarm1(alarm) : decodeAlarm2(alarm));\n        position.set(\"alarmCode\", alarm);\n        if (header != 0x2727) {\n            buf.readUnsignedByte(); \n            position.set(Position.KEY_ODOMETER, buf.readUnsignedInt());\n            int battery = BcdUtil.readInteger(buf, 2);\n            position.set(Position.KEY_BATTERY_LEVEL, battery > 0 ? battery : 100);\n        }\n        if (BitUtil.check(status, 6)) {\n            position.setValid(true);\n            position.setTime(readDate(buf));\n            position.setAltitude(buf.readFloatLE());\n            position.setLongitude(buf.readFloatLE());\n            position.setLatitude(buf.readFloatLE());\n            position.setSpeed(UnitsConverter.knotsFromKph(BcdUtil.readInteger(buf, 4) * 0.1));\n            position.setCourse(buf.readUnsignedShort());\n        } else {\n            getLastLocation(position, readDate(buf));\n            int mcc = buf.readUnsignedShortLE();\n            int mnc = buf.readUnsignedShortLE();\n            if (mcc != 0xffff && mnc != 0xffff) {\n                Network network = new Network();\n                for (int i = 0; i < 3; i++) {\n                    network.addCellTower(CellTower.from(\n                            mcc, mnc, buf.readUnsignedShortLE(), buf.readUnsignedShortLE()));\n                }\n                position.setNetwork(network);\n            }\n        }\n        if (header == 0x2727) {\n            byte[] accelerationBytes = new byte[5];\n            buf.readBytes(accelerationBytes);\n            long acceleration = new BigInteger(accelerationBytes).longValue();\n            double accelerationZ = BitUtil.between(acceleration, 8, 15) + BitUtil.between(acceleration, 4, 8) * 0.1;\n            if (!BitUtil.check(acceleration, 15)) {\n                accelerationZ = -accelerationZ;\n            }\n            double accelerationY = BitUtil.between(acceleration, 20, 27) + BitUtil.between(acceleration, 16, 20) * 0.1;\n            if (!BitUtil.check(acceleration, 27)) {\n                accelerationY = -accelerationY;\n            }\n            double accelerationX = BitUtil.between(acceleration, 28, 32) + BitUtil.between(acceleration, 32, 39) * 0.1;\n            if (!BitUtil.check(acceleration, 39)) {\n                accelerationX = -accelerationX;\n            }\n            position.set(Position.KEY_G_SENSOR, \"[\" + accelerationX + \",\" + accelerationY + \",\" + accelerationZ + \"]\");\n            int battery = BcdUtil.readInteger(buf, 2);\n            position.set(Position.KEY_BATTERY_LEVEL, battery > 0 ? battery : 100);\n            position.set(Position.KEY_DEVICE_TEMP, (int) buf.readByte());\n            position.set(\"lightSensor\", BcdUtil.readInteger(buf, 2) * 0.1);\n            position.set(Position.KEY_BATTERY, BcdUtil.readInteger(buf, 2) * 0.1);\n            position.set(\"solarPanel\", BcdUtil.readInteger(buf, 2) * 0.1);\n            position.set(Position.KEY_ODOMETER, buf.readUnsignedInt());\n            int inputStatus = buf.readUnsignedShort();\n            position.set(Position.KEY_IGNITION, BitUtil.check(inputStatus, 2));\n            position.set(Position.KEY_RSSI, BitUtil.between(inputStatus, 4, 11));\n            position.set(Position.KEY_INPUT, inputStatus);\n            buf.readUnsignedShort(); \n            buf.readUnsignedInt(); \n            buf.readUnsignedByte(); \n            buf.readUnsignedShort(); \n            buf.readUnsignedByte(); \n        } else {\n            if (buf.readableBytes() >= 2) {\n                position.set(Position.KEY_POWER, BcdUtil.readInteger(buf, 4) * 0.01);\n            }\n            if (buf.readableBytes() >= 19) {\n                position.set(Position.KEY_OBD_SPEED, BcdUtil.readInteger(buf, 4) * 0.01);\n                position.set(Position.KEY_FUEL_USED, buf.readUnsignedInt() * 0.001);\n                position.set(Position.KEY_FUEL_CONSUMPTION, buf.readUnsignedInt() * 0.001);\n                position.set(Position.KEY_RPM, buf.readUnsignedShort());\n                int value;\n                value = buf.readUnsignedByte();\n                if (value != 0xff) {\n                    position.set(\"airInput\", value);\n                }\n                if (value != 0xff) {\n                    position.set(\"airPressure\", value);\n                }\n                if (value != 0xff) {\n                    position.set(Position.KEY_COOLANT_TEMP, value - 40);\n                }\n                if (value != 0xff) {\n                    position.set(\"airTemp\", value - 40);\n                }\n                if (value != 0xff) {\n                    position.set(Position.KEY_ENGINE_LOAD, value);\n                }\n                if (value != 0xff) {\n                    position.set(Position.KEY_THROTTLE, value);\n                }\n                if (value != 0xff) {\n                    position.set(Position.KEY_FUEL_LEVEL, value);\n                }\n            }\n        }\n        boolean acknowledgement = AttributeUtil.lookup(\n                getCacheManager(), Keys.PROTOCOL_ACK.withPrefix(getProtocolName()), deviceSession.getDeviceId());\n        if (acknowledgement || type == MSG_ALARM || type == MSG_ALARM_2) {\n            sendResponse(channel, header, type, index, imei, alarm);\n        }\n        return position;\n    }\n", "result": 0}